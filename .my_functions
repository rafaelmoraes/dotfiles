#!/bin/bash -x
__extract_file_path(){
    if [[ $1 =~ "^/" ]]; then
    	file_name=${*##*/}
        file_path=${*%$file_name}
    else
        file_path="$(pwd)"
    fi
    echo "$file_path"
}

start_docker_daemon() {
    systemctl status docker &> /dev/null;
    if [ $? -ne 0 ]; then
       echo "Starting docker daemon...";
       sudo systemctl start docker &> /dev/null;
       xhost local:root &> /dev/null
       xhost local:"$USER" &> /dev/null
       echo "Docker daemon started.";
    fi
}

shell_container() {
	start_docker_daemon;
	sudo docker-compose up -d;
	docker-compose exec "$1" bash;
}

vim() {
    start_docker_daemon
    shared_dir=$(__extract_file_path "$@")
    docker run \
        --rm \
        -it \
        -w "$shared_dir" \
        -v "$shared_dir":"$shared_dir" \
        -v "$HOME"/.vim-undo:/home/developer/.vim-undo \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -e DISPLAY=unix"$DISPLAY" \
        rmoraes/vim vim "$@"
}

svim() {
    start_docker_daemon
    shared_dir=$(__extract_file_path "$@")

    docker run \
        --rm \
        -it \
        -w "/shared" \
        -v "$shared_dir:/shared" \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -e DISPLAY=unix"$DISPLAY" \
        rmoraes/vim sudo vim "$@"
}

__file_name() {
    file=$1
    case $2 in
        --get-extension )
            echo "$file" | awk -F '.' '{ print $NF }'
            ;;
        --remove-extension)
            ext=$(__file_name "$file" --get-extension)
            echo "${file%.$ext}"
            ;;
    esac
}

video_reencode() {
    video_in=$1
    if [[ -z "$2" || "$2" != "--low" ]]; then
        video_height=$(ffprobe \
                        -v quiet \
                        -print_format json \
                        -show_format \
                        -show_streams \
                        "$video_in" \
                        | grep '"height"' \
                        | awk -F ':' '{ print $2 }' \
                        | sed 's/,/p/; s/ //g')
        video_name=$(__file_name "$video_in" --remove-extension)
        video_extension=$(__file_name "$video_in" --get-extension)
        video_out="$video_name [x265 $video_height].$video_extension"
    else
        video_out=$2
    fi
    if [[ ! -z "$3" && "$3" == "--low" ]]; then
        echo '[USING LOW QUALITY MODE]'
        optirun ffmpeg -i "$video_in" -c:a copy -c:v libx265 "$video_out"
    else
        optirun ffmpeg -i "$video_in" -c:a copy -c:v libx265 -x265-params crf=25 "$video_out"
    fi
}
